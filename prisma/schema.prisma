generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Article {
  id              String         @id @default(uuid())
  title           String
  slug            String         @unique
  excerpt         String?
  content         String
  featuredImage   String?
  status          ArticleStatus  @default(DRAFT)
  publishedAt     DateTime?
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  metaTitle       String?
  metaDescription String?
  aiGenerated     Boolean        @default(false)
  aiPrompt        String?
  viewCount       Int            @default(0)
  category        String?
  tags            String?
  authorSlug      String?
  authorId        String?
  authorName      String?
  images          ArticleImage[]
  author          User?          @relation("UserArticles", fields: [authorId], references: [id])

  @@map("articles")
}

model Video {
  id              String           @id @default(uuid())
  title           String
  slug            String           @unique
  excerpt         String?
  content         String
  videoUrl        String?
  duration        String?
  thumbnail       String?
  featuredImage   String?
  status          ArticleStatus    @default(DRAFT)
  publishedAt     DateTime?
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  metaTitle       String?
  metaDescription String?
  aiGenerated     Boolean          @default(false)
  aiPrompt        String?
  viewCount       Int              @default(0)
  category        String?
  tags            String?
  authorId        String?
  authorName      String?
  authorSlug      String?
  courseId        String?
  order           Int              @default(0)
  progress        LessonProgress[]
  images          VideoImage[]
  author          User?            @relation("UserVideos", fields: [authorId], references: [id])
  course          Course?          @relation("CourseLessons", fields: [courseId], references: [id])

  @@map("videos")
}

model ArticleImage {
  id        String  @id @default(uuid())
  url       String
  alt       String?
  caption   String?
  articleId String
  article   Article @relation(fields: [articleId], references: [id], onDelete: Cascade)

  @@map("article_images")
}

model VideoImage {
  id      String  @id @default(uuid())
  url     String
  alt     String?
  caption String?
  videoId String
  video   Video   @relation(fields: [videoId], references: [id], onDelete: Cascade)

  @@map("video_images")
}

model User {
  id                       String             @id @default(uuid())
  email                    String             @unique
  username                 String?            @unique
  password                 String
  firstName                String?
  lastName                 String?
  avatar                   String?
  bio                      String?
  website                  String?
  emailVerified            Boolean            @default(false)
  emailVerificationToken   String?            @unique
  emailVerificationExpires DateTime?
  passwordResetToken       String?            @unique
  passwordResetExpires     DateTime?
  isActive                 Boolean            @default(true)
  lastLogin                DateTime?
  loginAttempts            Int                @default(0)
  lockUntil                DateTime?
  role                     UserRole           @default(USER)
  wordpressId              Int?               @unique
  wordpressMeta            String?
  createdAt                DateTime           @default(now())
  updatedAt                DateTime           @updatedAt
  fullNameArabic           String?
  fullNameEnglish          String?
  articles                 Article[]          @relation("UserArticles")
  certificates             Certificate[]      @relation("UserCertificates")
  enrollments              CourseEnrollment[] @relation("UserEnrollments")
  courses                  Course[]           @relation("UserCourses")
  progress                 LessonProgress[]   @relation("UserProgress")
  payments                 PaymentOrder[]     @relation("UserPayments")
  sessions                 UserSession[]
  videos                   Video[]            @relation("UserVideos")
  solutions                Solution[]         @relation("UserSolutions")
  solutionReviews          SolutionReview[]   @relation("UserReviews")
  solutionPurchases        SolutionPurchase[] @relation("UserPurchases")
  solutionDownloads        SolutionDownload[] @relation("UserDownloads")

  @@map("users")
}

model UserSession {
  id        String   @id @default(uuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  ipAddress String?
  userAgent String?
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_sessions")
}

model Course {
  id                String             @id @default(uuid())
  title             String
  slug              String             @unique
  description       String?
  excerpt           String?
  featuredImage     String?
  category          String?
  tags              String?
  status            ArticleStatus      @default(DRAFT)
  publishedAt       DateTime?
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  price             Float?             @default(0)
  currency          String?            @default("USD")
  isFree            Boolean            @default(true)
  isPrivate         Boolean            @default(false)
  authorId          String?
  authorName        String?
  totalLessons      Int                @default(0)
  durationValue     Int?
  durationUnit      String?
  level             CourseLevel        @default(BEGINNER)
  language          String?            @default("ar")
  titleEnglish      String?
  authorNameEnglish String?
  enrollments       CourseEnrollment[]
  author            User?              @relation("UserCourses", fields: [authorId], references: [id])
  paymentOrders     PaymentOrder[]
  lessons           Video[]            @relation("CourseLessons")

  @@map("courses")
}

model CourseEnrollment {
  id             String           @id @default(uuid())
  userId         String
  courseId       String
  enrolledAt     DateTime         @default(now())
  completedAt    DateTime?
  progress       Float            @default(0)
  isCompleted    Boolean          @default(false)
  certificates   Certificate[]
  course         Course           @relation(fields: [courseId], references: [id], onDelete: Cascade)
  user           User             @relation("UserEnrollments", fields: [userId], references: [id], onDelete: Cascade)
  lessonProgress LessonProgress[]

  @@unique([userId, courseId])
  @@map("course_enrollments")
}

model LessonProgress {
  id            String           @id @default(uuid())
  userId        String
  lessonId      String
  enrollmentId  String
  watchedTime   Int              @default(0)
  isCompleted   Boolean          @default(false)
  completedAt   DateTime?
  lastWatchedAt DateTime         @default(now())
  enrollment    CourseEnrollment @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)
  lesson        Video            @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  user          User             @relation("UserProgress", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, lessonId])
  @@map("lesson_progress")
}

model CertificateTemplate {
  id               String   @id @default(uuid())
  name             String
  language         String
  backgroundImage  String
  fields           Json
  isActive         Boolean  @default(true)
  isDefault        Boolean  @default(false)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  backgroundHeight Int      @default(3508)
  backgroundWidth  Int      @default(2480)
  arCertificates   Certificate[] @relation("ArCertificateTemplate")
  enCertificates   Certificate[] @relation("EnCertificateTemplate")

  @@map("certificate_templates")
}

model Certificate {
  id            String           @id @default(uuid())
  userId        String
  enrollmentId  String
  certificateId String           @unique
  data          Json
  createdAt     DateTime         @default(now())
  arTemplateId  String?
  enTemplateId  String?
  enrollment    CourseEnrollment @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)
  user          User             @relation("UserCertificates", fields: [userId], references: [id])
  arTemplate    CertificateTemplate? @relation("ArCertificateTemplate", fields: [arTemplateId], references: [id])
  enTemplate    CertificateTemplate? @relation("EnCertificateTemplate", fields: [enTemplateId], references: [id])

  @@unique([userId, enrollmentId])
  @@map("certificates")
}

model PaymentOrder {
  id              String               @id @default(uuid())
  userId          String
  courseId        String
  amount          Float
  currency        String               @default("USD")
  status          PaymentStatus        @default(PENDING)
  paypalOrderId   String?
  paypalPaymentId String?
  createdAt       DateTime             @default(now())
  updatedAt       DateTime             @updatedAt
  paidAt          DateTime?
  course          Course               @relation(fields: [courseId], references: [id], onDelete: Cascade)
  user            User                 @relation("UserPayments", fields: [userId], references: [id], onDelete: Cascade)
  refunds         PaymentRefund[]
  transactions    PaymentTransaction[]

  @@map("payment_orders")
}

model PaymentTransaction {
  id                  String        @id @default(uuid())
  orderId             String
  paypalTransactionId String        @unique
  amount              Float
  currency            String        @default("USD")
  status              PaymentStatus @default(PENDING)
  paypalFee           Float?
  netAmount           Float?
  createdAt           DateTime      @default(now())
  order               PaymentOrder  @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@map("payment_transactions")
}

model PaymentRefund {
  id             String       @id @default(uuid())
  orderId        String
  paypalRefundId String       @unique
  amount         Float
  currency       String       @default("USD")
  reason         String?
  status         RefundStatus @default(PENDING)
  requestedAt    DateTime     @default(now())
  processedAt    DateTime?
  order          PaymentOrder @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@map("payment_refunds")
}

enum ArticleStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

enum UserRole {
  ADMIN
  EDITOR
  AUTHOR
  USER
}

enum CourseLevel {
  BEGINNER
  INTERMEDIATE
  ADVANCED
}

enum PaymentStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED
  REFUNDED
  PARTIALLY_REFUNDED
}

enum RefundStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED
}

model Solution {
  id            String  @id @default(uuid())
  title         String
  slug          String  @unique
  description   String
  excerpt       String?
  featuredImage String?
  images        String? // JSON array of image URLs

  // Solution Type & Category
  solutionType SolutionType
  category     String?
  tags         String?

  // Pricing
  price    Float?  @default(0)
  currency String? @default("USD")
  isFree   Boolean @default(true)

  // Files & Downloads
  fileUrl          String? // Main download file URL
  fileSize         String? // e.g., "2.5 MB"
  fileType         String? // e.g., "Python Script", "ArcGIS Toolbox", etc.
  demoUrl          String? // Demo/preview URL
  documentationUrl String? // Documentation link
  sourceCodeUrl    String? // GitHub or source code link

  // Version & Compatibility
  version       String?
  lastUpdated   DateTime?
  compatibility String? // JSON array: ["ArcGIS Pro 3.x", "QGIS 3.x", etc.]
  requirements  String? // System requirements

  // Metadata
  status      ArticleStatus @default(DRAFT)
  publishedAt DateTime?
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  // Author/Seller
  authorId   String?
  authorName String?
  sellerInfo String? // JSON for future seller details

  // Stats & Engagement
  viewCount     Int    @default(0)
  downloadCount Int    @default(0)
  purchaseCount Int    @default(0)
  rating        Float? @default(0)
  reviewCount   Int    @default(0)

  // SEO
  metaTitle       String?
  metaDescription String?

  // Relations
  author    User?              @relation("UserSolutions", fields: [authorId], references: [id])
  reviews   SolutionReview[]
  purchases SolutionPurchase[]
  downloads SolutionDownload[]

  @@map("solutions")
}

model SolutionReview {
  id         String   @id @default(uuid())
  solutionId String
  userId     String
  rating     Int // 1-5 stars
  comment    String?
  isVerified Boolean  @default(false) // Verified purchase
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  solution Solution @relation(fields: [solutionId], references: [id], onDelete: Cascade)
  user     User     @relation("UserReviews", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, solutionId])
  @@map("solution_reviews")
}

model SolutionPurchase {
  id            String        @id @default(uuid())
  userId        String
  solutionId    String
  amount        Float
  currency      String        @default("USD")
  status        PaymentStatus @default(PENDING)
  paypalOrderId String?
  purchasedAt   DateTime      @default(now())

  solution Solution @relation(fields: [solutionId], references: [id], onDelete: Cascade)
  user     User     @relation("UserPurchases", fields: [userId], references: [id], onDelete: Cascade)

  @@map("solution_purchases")
}

model SolutionDownload {
  id           String   @id @default(uuid())
  userId       String? // Can be null for anonymous downloads of free items
  solutionId   String
  downloadedAt DateTime @default(now())
  ipAddress    String?

  solution Solution @relation(fields: [solutionId], references: [id], onDelete: Cascade)
  user     User?    @relation("UserDownloads", fields: [userId], references: [id], onDelete: Cascade)

  @@map("solution_downloads")
}

enum SolutionType {
  TOOL // Standalone tools
  ADDIN // Add-ins/Extensions
  PLUGIN // Plugins
  SCRIPT // Python, JavaScript, etc.
  DATASET // Data files
  TEMPLATE // Project templates
  TOOLBOX // ArcGIS Toolboxes
  MODEL // Model Builder models
  STYLE // Map styles/symbology
  WIDGET // Web widgets
  APPLICATION // Full applications
  SERVICE // Web services/APIs
  EXTENSION // Browser extensions
  LIBRARY // Code libraries
  CONFIGURATION // Configuration files
  OTHER // Other types
}
