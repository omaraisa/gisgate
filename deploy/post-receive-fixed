#!/bin/bash
set -e

WORK_TREE="/opt/apps/gisgate"
GIT_DIR="/opt/deploy/gisgate.git"
UPSTREAM_FILE="/etc/nginx/upstreams/gisgate_upstream.conf"

mkdir -p "$WORK_TREE"

echo "Checking out latest code"
git --git-dir="$GIT_DIR" --work-tree="$WORK_TREE" checkout -f main

cd "$WORK_TREE"

echo "Detecting current deployment"
# Check which container is running
BLUE_RUNNING=$(docker ps -q --filter "name=gisgate_blue" --filter "status=running")
GREEN_RUNNING=$(docker ps -q --filter "name=gisgate_green" --filter "status=running")

if [ -n "$BLUE_RUNNING" ] && [ -z "$GREEN_RUNNING" ]; then
    CURRENT="blue"
    TARGET="green"
    TARGET_PORT="8002"
elif [ -n "$GREEN_RUNNING" ] && [ -z "$BLUE_RUNNING" ]; then
    CURRENT="green"
    TARGET="blue"
    TARGET_PORT="8001"
elif [ -n "$BLUE_RUNNING" ] && [ -n "$GREEN_RUNNING" ]; then
    # Both running - check nginx config to see which is active
    if grep -q "127.0.0.1:8001" "$UPSTREAM_FILE" 2>/dev/null; then
        CURRENT="blue"
        TARGET="green"
        TARGET_PORT="8002"
    else
        CURRENT="green"
        TARGET="blue"
        TARGET_PORT="8001"
    fi
else
    # Nothing running - start with blue
    CURRENT="none"
    TARGET="blue"
    TARGET_PORT="8001"
fi

echo "Current: $CURRENT"
echo "Target:  $TARGET"

# Build and start target container
echo "Starting $TARGET container on port $TARGET_PORT..."

# First, stop and remove any existing container with the same name
docker stop "gisgate_$TARGET" 2>/dev/null || true
docker rm "gisgate_$TARGET" 2>/dev/null || true

if [ "$TARGET" = "blue" ]; then
    docker compose -f docker-compose.blue.yml up -d --build
else
    docker compose -f docker-compose.green.yml up -d --build
fi

# Wait for container to be healthy
echo "Waiting for $TARGET container to be healthy..."
TARGET_CONTAINER="gisgate_$TARGET"

for i in {1..60}; do
    if docker inspect "$TARGET_CONTAINER" --format='{{.State.Health.Status}}' 2>/dev/null | grep -q "healthy"; then
        echo "$TARGET container is healthy!"
        break
    fi
    if [ $i -eq 60 ]; then
        echo "Timeout waiting for $TARGET container to be healthy"
        docker logs "$TARGET_CONTAINER" --tail 20
        exit 1
    fi
    echo "Waiting... ($i/60)"
    sleep 2
done

# Switch nginx upstream
echo "Switching nginx to $TARGET..."
if bash /opt/apps/gisgate/deploy/switch-upstream.sh "$TARGET"; then
    echo "✅ Nginx switch successful"
else
    echo "❌ Nginx switch failed - keeping old container running"
    # Stop the new container since nginx switch failed
    if [ "$TARGET" = "blue" ]; then
        docker compose -f docker-compose.blue.yml down
    else
        docker compose -f docker-compose.green.yml down
    fi
    exit 1
fi

# Stop old container only after successful switch
if [ "$CURRENT" != "none" ] && [ "$CURRENT" != "$TARGET" ]; then
    echo "Stopping old $CURRENT container..."
    if [ "$CURRENT" = "blue" ]; then
        docker compose -f docker-compose.blue.yml down
    else
        docker compose -f docker-compose.green.yml down
    fi
fi

echo "Deployment complete! Active: $TARGET on port $TARGET_PORT"