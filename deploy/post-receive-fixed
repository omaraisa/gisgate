#!/bin/bash
set -e

echo "ðŸš€ Starting blue-green deployment..."

# Set variables
WORK_TREE="/opt/apps/gisgate"
GIT_DIR="/opt/deploy/gisgate.git"
UPSTREAM_FILE="/etc/nginx/upstreams/gisgate_upstream.conf"

# Ensure working directory exists
mkdir -p $WORK_TREE

# Checkout latest code
echo "ðŸ“¥ Checking out latest code..."
git --git-dir=$GIT_DIR --work-tree=$WORK_TREE checkout -f main

# Change to working directory
cd $WORK_TREE

# Determine current active environment with better logic
echo "ðŸ” Determining current active environment..."

CURRENT=""
TARGET=""
CURRENT_PORT=""
TARGET_PORT=""
TARGET_COMPOSE=""

# First, check the nginx upstream file
if [ -f "$UPSTREAM_FILE" ]; then
    if grep -q "127.0.0.1:8001" "$UPSTREAM_FILE"; then
        CURRENT="blue"
        TARGET="green"
        CURRENT_PORT="8001"
        TARGET_PORT="8002"
        TARGET_COMPOSE="docker-compose.green.yml"
        echo "ðŸ“„ Nginx upstream shows BLUE (8001) is currently active"
    elif grep -q "127.0.0.1:8002" "$UPSTREAM_FILE"; then
        CURRENT="green"
        TARGET="blue"
        CURRENT_PORT="8002"
        TARGET_PORT="8001"
        TARGET_COMPOSE="docker-compose.blue.yml"
        echo "ðŸ“„ Nginx upstream shows GREEN (8002) is currently active"
    fi
fi

# If we couldn't determine from nginx config, check running containers
if [ -z "$CURRENT" ]; then
    echo "ðŸ” Nginx upstream unclear, checking running containers..."
    
    BLUE_RUNNING=$(docker ps -q -f name=gisgate_blue 2>/dev/null || echo "")
    GREEN_RUNNING=$(docker ps -q -f name=gisgate_green 2>/dev/null || echo "")
    
    if [ -n "$BLUE_RUNNING" ] && [ -z "$GREEN_RUNNING" ]; then
        CURRENT="blue"
        TARGET="green"
        CURRENT_PORT="8001"
        TARGET_PORT="8002"
        TARGET_COMPOSE="docker-compose.green.yml"
        echo "ðŸ³ Container check shows BLUE is running, GREEN is not"
    elif [ -n "$GREEN_RUNNING" ] && [ -z "$BLUE_RUNNING" ]; then
        CURRENT="green"
        TARGET="blue"
        CURRENT_PORT="8002"
        TARGET_PORT="8001"
        TARGET_COMPOSE="docker-compose.blue.yml"
        echo "ðŸ³ Container check shows GREEN is running, BLUE is not"
    elif [ -n "$BLUE_RUNNING" ] && [ -n "$GREEN_RUNNING" ]; then
        # Both running, default to switching to blue (prefer blue when uncertain)
        CURRENT="green"
        TARGET="blue"
        CURRENT_PORT="8002"
        TARGET_PORT="8001"
        TARGET_COMPOSE="docker-compose.blue.yml"
        echo "ðŸ³ Both containers running, defaulting to deploy BLUE"
    else
        # Nothing running, start with blue
        CURRENT="none"
        TARGET="blue"
        CURRENT_PORT="none"
        TARGET_PORT="8001"
        TARGET_COMPOSE="docker-compose.blue.yml"
        echo "ðŸ³ No containers running, starting with BLUE"
    fi
fi

echo "ðŸŽ¯ Current: $CURRENT ($CURRENT_PORT) â†’ Deploying to: $TARGET ($TARGET_PORT)"

# Build and start target environment
echo "ðŸ”¨ Building and starting $TARGET environment..."
docker-compose -f $TARGET_COMPOSE down --remove-orphans 2>/dev/null || true

if ! docker-compose -f $TARGET_COMPOSE up -d --build; then
    echo "âŒ Failed to build/start $TARGET environment"
    exit 1
fi

# Wait for container to be ready with better feedback
echo "â³ Waiting for $TARGET container to be ready..."
HEALTH_CHECK_COUNT=0
MAX_ATTEMPTS=60

while [ $HEALTH_CHECK_COUNT -lt $MAX_ATTEMPTS ]; do
    if curl -f -s http://localhost:$TARGET_PORT/api/health >/dev/null 2>&1; then
        echo "âœ… $TARGET environment is healthy!"
        break
    fi
    HEALTH_CHECK_COUNT=$((HEALTH_CHECK_COUNT + 1))
    echo "Waiting... ($HEALTH_CHECK_COUNT/$MAX_ATTEMPTS)"
    sleep 2
done

# Final health check
if ! curl -f -s http://localhost:$TARGET_PORT/api/health >/dev/null 2>&1; then
    echo "âŒ Health check failed for $TARGET environment after $MAX_ATTEMPTS attempts"
    echo "ðŸ”„ Rolling back..."
    docker-compose -f $TARGET_COMPOSE down
    exit 1
fi

# Additional verification - make sure container is actually running
TARGET_CONTAINER_NAME="gisgate_${TARGET}"
if ! docker ps -q -f name=$TARGET_CONTAINER_NAME | grep -q .; then
    echo "âŒ $TARGET container is not running despite health check"
    echo "ðŸ”„ Rolling back..."
    docker-compose -f $TARGET_COMPOSE down
    exit 1
fi

# Switch nginx upstream (this should be instantaneous)
echo "ðŸ”„ Switching nginx to $TARGET environment..."
if ! /opt/apps/switch-upstream.sh $TARGET; then
    echo "âŒ Failed to switch nginx upstream"
    echo "ðŸ”„ Rolling back..."
    docker-compose -f $TARGET_COMPOSE down
    exit 1
fi

# Give nginx a moment to apply the configuration
echo "â³ Waiting for nginx to apply new configuration..."
sleep 3

# Verify the switch worked by checking nginx config
if [ -f "$UPSTREAM_FILE" ]; then
    if [ "$TARGET" = "blue" ] && ! grep -q "127.0.0.1:8001" "$UPSTREAM_FILE"; then
        echo "âš ï¸  Warning: Nginx upstream may not have switched to blue correctly"
    elif [ "$TARGET" = "green" ] && ! grep -q "127.0.0.1:8002" "$UPSTREAM_FILE"; then
        echo "âš ï¸  Warning: Nginx upstream may not have switched to green correctly"
    else
        echo "âœ… Nginx upstream successfully switched to $TARGET"
    fi
fi

# Only stop old environment if we had one running
if [ "$CURRENT" != "none" ]; then
    echo "ðŸ›‘ Stopping $CURRENT environment..."
    if [ "$CURRENT" = "blue" ]; then
        docker-compose -f docker-compose.blue.yml down
    else
        docker-compose -f docker-compose.green.yml down
    fi
    echo "âœ… $CURRENT environment stopped"
else
    echo "â„¹ï¸  No previous environment to stop"
fi

# Final verification
echo "ðŸ” Final verification..."
if curl -f -s http://localhost:$TARGET_PORT/api/health >/dev/null 2>&1; then
    echo "ðŸŽ‰ Deployment complete! Now serving from $TARGET environment on port $TARGET_PORT"
    echo "ðŸŒ Site should be accessible and healthy"
else
    echo "âš ï¸  Warning: Final health check failed, but deployment completed"
fi

# Clean up any dangling images to save space
echo "ðŸ§¹ Cleaning up dangling images..."
docker image prune -f >/dev/null 2>&1 || true

echo "âœ¨ Deployment finished successfully!"