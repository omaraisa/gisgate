#!/bin/bash
set -e

WORK_TREE="/opt/apps/gisgate"
GIT_DIR="/opt/deploy/gisgate.git"
UPSTREAM_FILE="/etc/nginx/upstreams/gisgate_upstream.conf"

mkdir -p "$WORK_TREE"

echo "Checking out latest code"
git --git-dir="$GIT_DIR" --work-tree="$WORK_TREE" checkout -f main

cd "$WORK_TREE"

echo "Detecting current deployment"
BLUE_ACTIVE=$(docker ps --filter "name=^gisgate_blue$" --filter "status=running" --format '{{.Names}}')
GREEN_ACTIVE=$(docker ps --filter "name=^gisgate_green$" --filter "status=running" --format '{{.Names}}')

TARGET=""
CURRENT=""
TARGET_COMPOSE=""
TARGET_PORT=""

if [ -n "$BLUE_ACTIVE" ] && [ -z "$GREEN_ACTIVE" ]; then
    CURRENT="blue"
    TARGET="green"
    TARGET_COMPOSE="docker-compose.green.yml"
    TARGET_PORT="8002"
elif [ -n "$GREEN_ACTIVE" ] && [ -z "$BLUE_ACTIVE" ]; then
    CURRENT="green"
    TARGET="blue"
    TARGET_COMPOSE="docker-compose.blue.yml"
    TARGET_PORT="8001"
else
    if grep -q "127.0.0.1:8001" "$UPSTREAM_FILE" 2>/dev/null; then
        CURRENT="blue"
        TARGET="green"
        TARGET_COMPOSE="docker-compose.green.yml"
        TARGET_PORT="8002"
    elif grep -q "127.0.0.1:8002" "$UPSTREAM_FILE" 2>/dev/null; then
        CURRENT="green"
        TARGET="blue"
        TARGET_COMPOSE="docker-compose.blue.yml"
        TARGET_PORT="8001"
    else
        CURRENT="none"
        TARGET="blue"
        TARGET_COMPOSE="docker-compose.blue.yml"
        TARGET_PORT="8001"
    fi
fi

echo "Current slot: $CURRENT"
echo "Target slot:  $TARGET"

# Give a moment for any previous operations to settle
sleep 2

docker-compose -f "$TARGET_COMPOSE" down --remove-orphans 2>/dev/null || true
docker-compose -f "$TARGET_COMPOSE" up -d --build

TARGET_CONTAINER="gisgate_${TARGET}"

echo "Waiting for $TARGET_CONTAINER to report running"
for attempt in {1..30}; do
    STATUS=$(docker inspect -f '{{.State.Status}}' "$TARGET_CONTAINER" 2>/dev/null || echo "missing")
    if [ "$STATUS" = "running" ]; then
        echo "$TARGET_CONTAINER is running"
        # Give it a few more seconds to fully initialize
        sleep 5
        break
    fi
    echo "Attempt $attempt/30 -> status $STATUS"
    sleep 2
done

STATUS=$(docker inspect -f '{{.State.Status}}' "$TARGET_CONTAINER" 2>/dev/null || echo "missing")
if [ "$STATUS" != "running" ]; then
    echo "Target container did not reach running state"
    docker-compose -f "$TARGET_COMPOSE" down
    exit 1
fi

echo "Switching nginx upstream to $TARGET"
/opt/apps/switch-upstream.sh "$TARGET"

if [ "$CURRENT" = "blue" ]; then
    docker-compose -f docker-compose.blue.yml down 2>/dev/null || true
elif [ "$CURRENT" = "green" ]; then
    docker-compose -f docker-compose.green.yml down 2>/dev/null || true
fi

echo "Deployment finished -> active slot $TARGET on port $TARGET_PORT"